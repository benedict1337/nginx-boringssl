name: NGINX-BoringSSL (Update versions)

on:
  push:
    branches:
      - main
    paths:
      - Dockerfile
      - Dockerfile.nonmodsec
  schedule:
    - cron: "0 0 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dep:
          - { name: "NGINX Mainline", var: "NGX_MAINLINE_VER", repo: "https://github.com/nginx/nginx.git", filter: "release-" }
          - { name: "ModSecurity", var: "MODSEC_VER", repo: "https://github.com/owasp-modsecurity/ModSecurity.git" }
          - { name: "BoringSSL", var: "BORINGSSL_VER", repo: "https://github.com/google/boringssl.git", branch: "main" }
          - { name: "Headers More Module", var: "NGX_HEADERS_MORE", repo: "https://github.com/openresty/headers-more-nginx-module.git" }
          - { name: "NJS Module", var: "NGX_NJS", repo: "https://github.com/nginx/njs.git" }
          - { name: "NGX ModSecurity Module", var: "NGX_MODSEC", repo: "https://github.com/SpiderLabs/ModSecurity-nginx.git" }
          - { name: "GeoIP2 Module", var: "NGX_GEOIP2", repo: "https://github.com/leev/ngx_http_geoip2_module.git" }
          - { name: "TLS Dyn Size Module", var: "NGX_TLS_DYN_SIZE", repo: "https://github.com/nginx-modules/ngx_http_tls_dyn_size.git", special: "patch" }

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Get latest version
        id: getver
        run: |
          if [ "${{ matrix.dep.special || '' }}" = "patch" ]; then
            VER=$(curl -s https://api.github.com/repos/nginx-modules/ngx_http_tls_dyn_size/contents/ \
              | jq -r '.[].name' | grep -E '\.patch$' | sort -V | tail -1)
          elif [ "${{ matrix.dep.name }}" = "BoringSSL" ]; then
            VER=$(git ls-remote "${{ matrix.dep.repo }}" "${{ matrix.dep.branch }}" | awk '{print $2}' | cut -c12-15)
          elif [ -n "${{ matrix.dep.branch || '' }}" ]; then
            VER=$(git ls-remote --heads "${{ matrix.dep.repo }}" "${{ matrix.dep.branch }}" \
              | awk -F'/' '{print $3}' | sort -V | tail -1)
          else
            VER=$(git ls-remote --refs --tags "${{ matrix.dep.repo }}" \
              | awk -F'/' '{print $3}' | sed "s/^${{ matrix.dep.filter || '' }}//" | sort -V | tail -1)
          fi

          echo "VER=$VER" >> $GITHUB_OUTPUT
          sed -i "s|ARG ${{ matrix.dep.var }}=.*|ARG ${{ matrix.dep.var }}=${VER}|g" Dockerfile
          sed -i "s|ARG ${{ matrix.dep.var }}=.*|ARG ${{ matrix.dep.var }}=${VER}|g" Dockerfile.nonmodsec || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          signoff: true
          delete-branch: true
          commit-message: "⬆️ Update ${{ matrix.dep.name }} to ${{ steps.getver.outputs.VER }}"
          title: "⬆️ Update ${{ matrix.dep.name }} to ${{ steps.getver.outputs.VER }}"
          body: |
            ## 🔄 Dependency Update

            This PR updates **${{ matrix.dep.name }}** to version:
            ```
            ${{ steps.getver.outputs.VER }}
            ```

            ### 📦 Updated Component
            - **Variable:** `${{ matrix.dep.var }}`
            - **Repository:** [${{ matrix.dep.repo }}](${{ matrix.dep.repo }})
            - **New Version:** `${{ steps.getver.outputs.VER }}`

            ### 📜 Changelog / Commits
            - [View history](${{ matrix.dep.repo }}/commits/${{ matrix.dep.branch || 'master' }})

            ### ✅ Notes
            - Automated update generated by GitHub Actions.
            - Triggered on branch: `${{ github.ref_name }}`
            - Schedule: Daily (`0 0 * * *`)

            ---
            _Maintained by CI • Please review and merge if appropriate._
          branch: update-version-${{ matrix.dep.var }}-${{ steps.getver.outputs.VER }}
          base: ${{ github.ref_name }}
          labels: dependencies